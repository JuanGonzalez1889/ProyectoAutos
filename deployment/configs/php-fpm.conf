# ===================================================================
# CONFIGURACIÓN PHP-FPM PARA AUTOWEB PRO
# ===================================================================
# Ubicación: /etc/php/8.2/fpm/pool.d/autoweb.conf
# ===================================================================

[autoweb]

# === USUARIO Y GRUPO ===
user = www-data
group = www-data

# === SOCKET ===
listen = /var/run/php/php8.2-fpm-autoweb.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

# === PROCESS MANAGER ===
# dynamic = ajusta procesos según demanda
pm = dynamic

# Máximo de procesos hijos
pm.max_children = 50

# Procesos al iniciar
pm.start_servers = 10

# Mínimo de procesos inactivos
pm.min_spare_servers = 5

# Máximo de procesos inactivos
pm.max_spare_servers = 20

# Número de requests antes de respawn (evita memory leaks)
pm.max_requests = 500

# === STATUS PAGE (para monitoreo) ===
pm.status_path = /fpm-status
pm.status_listen = 127.0.0.1:9000

# === PERFORMANCE SETTINGS ===
; Memory limit por request
php_admin_value[memory_limit] = 256M

; Upload max filesize
php_admin_value[upload_max_filesize] = 20M
php_admin_value[post_max_size] = 20M

; Execution time
php_admin_value[max_execution_time] = 60
php_admin_value[max_input_time] = 60

; Input variables
php_admin_value[max_input_vars] = 3000

; === OPCACHE (CRÍTICO PARA PERFORMANCE) ===
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 20000

; Validación de timestamps (0 = deshabilitado en producción)
; ⚠️ Con 0, cambios en código requieren: systemctl reload php8.2-fpm
php_admin_value[opcache.validate_timestamps] = 0

; Revalidación cada 2 segundos si validate_timestamps = 1
php_admin_value[opcache.revalidate_freq] = 2

; Fast shutdown
php_admin_value[opcache.fast_shutdown] = 1

; Optimizaciones adicionales
php_admin_value[opcache.enable_file_override] = 1
php_admin_value[opcache.huge_code_pages] = 1

; === REALPATH CACHE ===
php_admin_value[realpath_cache_size] = 4096K
php_admin_value[realpath_cache_ttl] = 600

; === SESSION CONFIGURATION ===
; Laravel usa Redis para sessions, pero configuramos fallback
php_admin_value[session.save_handler] = files
php_admin_value[session.save_path] = /var/lib/php/sessions
php_admin_value[session.gc_maxlifetime] = 7200

; === ERROR LOGGING ===
php_admin_flag[display_errors] = off
php_admin_flag[display_startup_errors] = off
php_admin_value[error_reporting] = E_ALL & ~E_DEPRECATED & ~E_STRICT
php_admin_value[error_log] = /var/log/php-fpm-autoweb-error.log

; === SECURITY ===
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen
php_admin_value[expose_php] = off

; === TIMEZONE ===
php_admin_value[date.timezone] = America/Argentina/Buenos_Aires

; === ENVIRONMENT VARIABLES ===
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp
